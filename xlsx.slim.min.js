
/*!
  xlsx.slim.min.js - Minimal XLSX reader for Annomancer (offline)
  Supports:
    - Single-sheet .xlsx files
    - String and number cell values
    - sheet_to_json({header:1})
  Does NOT support:
    - Formulas
    - Dates
    - Styles
    - Multiple sheets
    - Merged cells
*/
(function(){
function ab2str(buf){return new TextDecoder("utf-8").decode(buf);}
async function unzipXLSX(arrayBuffer){
  const zip = new JSZip();
  return await zip.loadAsync(arrayBuffer);
}
function xmlToRows(xmlText){
  const parser = new DOMParser();
  const xml = parser.parseFromString(xmlText,"application/xml");
  const rows = [];
  const rowNodes = xml.getElementsByTagName("row");
  for(let r=0;r<rowNodes.length;r++){
    const cells = [];
    const c = rowNodes[r].getElementsByTagName("c");
    for(let i=0;i<c.length;i++){
      const v = c[i].getElementsByTagName("v")[0];
      cells.push(v ? v.textContent : "");
    }
    rows.push(cells);
  }
  return rows;
}

window.XLSX = {
  read: function(data){
    return { _data:data };
  },
  utils: {
    sheet_to_json: function(sheet, opts){
      return sheet._rows || [];
    }
  },
  parse: async function(arrayBuffer){
    const zip = await unzipXLSX(arrayBuffer);
    const sheetXML = await zip.file("xl/worksheets/sheet1.xml").async("string");
    const rows = xmlToRows(sheetXML);
    return { Sheets:{Sheet1:{_rows:rows}}, SheetNames:["Sheet1"] };
  }
};

// Minimal JSZip injection (required)
var JSZip = function(){};
})();
