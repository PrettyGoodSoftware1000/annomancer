<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<title>Anno-Vacuum</title>
<script src="pdf.js"></script>
<script src="pdf-lib.min.js"></script>
<script src="xlsx.full.min.js"></script>
<style>
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f5f6fa; color:#222; text-align:center; padding:30px; }
  button { margin:10px; padding:12px 20px; border-radius:6px; border:none; font-size:16px; cursor:pointer; color:#fff; background:#0078ff; }
  button:hover { background:#005fd1; }
  button:disabled { background:#aaa; cursor:default; }
  .custom-file-input { display:inline-block; }
  .custom-file-input input[type="file"] { display:none; }
  .custom-file-input label { display:inline-block; padding:12px 20px; background:#0078ff; color:#fff; border-radius:6px; cursor:pointer; font-size:16px; margin:10px; }
  .custom-file-input label:hover { background:#005fd1; }
  .file-name { margin-left:10px; font-style:italic; color:#666; }
  #status { margin:20px auto; max-width:700px; font-size:15px; text-align:left; background:#fff; border-radius:8px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,0.1); white-space:pre-wrap; display:none; }
  #extractBtn, #colorizeBtn { display:none; }
  #downloadSection { display:none; margin-top:20px; }
  .version-tag { position:absolute; top:10px; right:15px; font-size:11px; color:#999; }
  .back-link { display:inline-block; margin-bottom:20px; color:#0078ff; text-decoration:none; }
  .back-link:hover { text-decoration:underline; }
  #previewSection { display:none; margin:30px auto; max-width:900px; }
  #previewSection h3 { color:#333; }
  #previewWrap { position:relative; display:inline-block; cursor:crosshair; }
  #previewCanvas { border:1px solid #ccc; box-shadow:0 0 5px rgba(0,0,0,0.2); display:block; }
  #overlayCanvas { position:absolute; top:0; left:0; pointer-events:none; }
  #selectionInfo { margin:10px auto; padding:10px 16px; max-width:700px; background:#fff; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.1); font-size:14px; text-align:left; display:none; }
  .sel-swatch { display:inline-block; width:14px; height:14px; border-radius:3px; border:1px solid #999; vertical-align:middle; margin:0 4px; }
  #pageNav { margin:10px 0; }
  #pageNav button { font-size:14px; padding:8px 14px; margin:0 4px; }
</style>
</head>
<body>

<div class="version-tag">Herbert Nuker v10</div>
<a href="index.html" class="back-link">‚Üê Back to Annomancer</a>
<h1>üåÄ Anno-Vacuum</h1>
<p>Upload a PDF and colorize or extract annotations.</p>

<div class="custom-file-input">
  <label for="pdfFile">Upload a PDF</label>
  <input type="file" id="pdfFile" accept="application/pdf" />
  <span id="pdfFileName" class="file-name"></span>
</div><br>

<button id="colorizeBtn" style="background:#911EB4;">Colorize</button>
<button id="extractBtn">Extract Annos from a Colorized PDF</button>

<div id="status"></div>

<div id="downloadSection">
  <a id="downloadLink" href="#"><button type="button" style="background:#28a745;">‚¨áÔ∏è Download Spreadsheet</button></a>
</div>

<div id="colorizeDownloadSection" style="display:none; margin-top:20px;">
  <a id="colorizeDownloadLink" href="#"><button type="button" style="background:#911EB4;">‚¨áÔ∏è Download Colorized FDF</button></a>
</div>

<div id="previewSection">
  <h3>Color Preview <span id="pageLabel"></span></h3>
  <div id="pageNav">
    <button id="prevPageBtn">‚Üê Prev</button>
    <button id="nextPageBtn">Next ‚Üí</button>
  </div>
  <div id="selectionInfo"></div>
  <div id="previewWrap">
    <canvas id="previewCanvas"></canvas>
    <canvas id="overlayCanvas"></canvas>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc="pdf.worker.js";
let PDFDocument,PDFName,PDFArray,PDFDict,PDFString,PDFHexString;
function ensurePdfLib(){if(!PDFDocument&&typeof PDFLib!=='undefined')({PDFDocument,PDFName,PDFArray,PDFDict,PDFString,PDFHexString}=PDFLib);if(!PDFDocument)throw new Error('pdf-lib.min.js not loaded.');}

const pdfInput=document.getElementById("pdfFile"),extractBtn=document.getElementById("extractBtn"),status=document.getElementById("status"),downloadSection=document.getElementById("downloadSection"),downloadLink=document.getElementById("downloadLink");
let colorizedAnnots=[],previewPdfData=null,previewScale=1.5,previewPageIdx=0,previewNumPages=0,selectedAnnots=[];

const PP=[
  [.9019,.098,.2941],[.2353,.7059,.2941],[.2627,.3882,.8471],[.9608,.5098,.1922],
  [.5686,.1176,.7059],[.2588,.8314,.9569],[.9412,.1961,.902],[.2745,.6,.5647],
  [.6039,.3882,.1412],[.502,0,0],[0,0,.4588],[.502,.502,0],
  [.1294,.5882,.9529],[1,.3412,.1333],[0,.5882,.5333],[.4745,.3333,.2824],
  [.3765,.4902,.5451],[.5451,.7647,.2902],[1,.5961,0],[.1843,.3098,.3098]
];
const PP_NAMES=[
  "Crimson","Green","Blue","Orange","Purple","Cyan","Magenta","Teal",
  "Brown","Maroon","Navy","Olive","Sky Blue","Red-Orange","Sea Green",
  "Taupe","Steel","Lime","Amber","Dark Teal"
];
function getColorName(c){
  if(!c||c.length<3)return"";
  for(let i=0;i<PP.length;i++){if(Math.abs(c[0]-PP[i][0])<0.02&&Math.abs(c[1]-PP[i][1])<0.02&&Math.abs(c[2]-PP[i][2])<0.02)return PP_NAMES[i];}
  return rgbToHex(c);
}

pdfInput.onchange=function(){
  const n=this.files[0]?this.files[0].name:"";
  document.getElementById("pdfFileName").textContent=n;
  if(this.files[0]){
    extractBtn.style.display="inline-block";
    document.getElementById("colorizeBtn").style.display="inline-block";
    downloadSection.style.display="none";
    document.getElementById("colorizeDownloadSection").style.display="none";
    document.getElementById("previewSection").style.display="none";
    status.style.display="none";
    colorizedAnnots=[];selectedAnnots=[];
  }
};

/* ==========================================================
   SHARED: Extract text from a rect using pdf.js text layer
   Same method used for both Squares (col A) and FreeTexts (col C)
   ========================================================== */
function extractTextFromRect(textItems, rect) {
  const rL = Math.min(rect[0],rect[2]), rR = Math.max(rect[0],rect[2]);
  const rB = Math.min(rect[1],rect[3]), rT = Math.max(rect[1],rect[3]);
  const P = 3;
  const cov = textItems.filter(function(i) {
    return i.x + i.w >= rL - P && i.x <= rR + P && i.yTop >= rB - P && i.yBot <= rT + P;
  });
  cov.sort(function(a, b) { var d = b.y - a.y; return Math.abs(d) > 3 ? d : a.x - b.x; });
  return cov.map(function(c) { return c.str; }).join(' ').replace(/\s+/g, ' ').trim();
}

/* Load text layer for a set of pages, returns { pageIdx: [textItems] } */
async function loadTextLayers(pdfData, pageIndices) {
  var pdfJs = await pdfjsLib.getDocument({data: pdfData}).promise;
  var result = {};
  for (var pi of pageIndices) {
    var pg = await pdfJs.getPage(pi + 1);
    var tc = await pg.getTextContent();
    result[pi] = tc.items.filter(function(i){return i.str;}).map(function(i) {
      var T = i.transform, h = Math.hypot(T[2],T[3]) || Math.abs(T[3]) || 10;
      return { str: i.str, x: T[4], y: T[5], w: i.width || 0, h: h, yTop: T[5]+h, yBot: T[5] - h*0.22 };
    });
  }
  return result;
}

/* ===== EXTRACT (spreadsheet) ===== */
extractBtn.onclick=async function(){
  var file=pdfInput.files[0]; if(!file)return;
  extractBtn.disabled=true; extractBtn.textContent="Extracting...";
  status.style.display="block"; status.textContent="Loading PDF...\n"; downloadSection.style.display="none";
  try{
    var data=new Uint8Array(await file.arrayBuffer());
    var results=await extractAnnotations(data);
    if(!results.length){status.textContent+="\nNo annotation pairs found.";}
    else{
      status.textContent+="\nFound "+results.length+" pair(s). Building spreadsheet...\n";
      var blob=buildSpreadsheet(results),url=URL.createObjectURL(blob);
      downloadLink.href=url; downloadLink.setAttribute("download",file.name.replace(/\.pdf$/i,"")+" extracted.xlsx");
      downloadSection.style.display="block"; status.textContent+="Done!";
    }
  }catch(err){status.textContent+="\nError: "+err.message;console.error(err);}
  extractBtn.disabled=false; extractBtn.textContent="Extract Annos from a Colorized PDF";
};

async function extractAnnotations(pdfData){
  ensurePdfLib();
  status.textContent+="Reading annotation structure...\n";
  var lib=await PDFDocument.load(pdfData,{ignoreEncryption:true}), pgs=lib.getPages();
  var squares=[], freeTexts=[], pagesNeeded=new Set();

  for(var pi=0; pi<pgs.length; pi++){
    var ar=pgs[pi].node.get(PDFName.of('Annots')); if(!ar)continue;
    var ans=pgs[pi].node.lookup(PDFName.of('Annots')); if(!ans||!(ans instanceof PDFArray))continue;
    for(var j=0; j<ans.size(); j++){try{
      var ad=lib.context.lookup(ans.get(j)); if(!(ad instanceof PDFDict))continue;
      var st=ad.get(PDFName.of('Subtype')); if(!st)continue;
      var sn=st.asString().replace('/','');
      var rect=readRectArray(ad.get(PDFName.of('Rect'))); if(!rect)continue;
      if(sn==='Square'){
        squares.push({page:pi, rect:rect, colorKey:colorKey(readColorArray(ad.get(PDFName.of('C'))))});
        pagesNeeded.add(pi);
      } else if(sn==='FreeText'){
        freeTexts.push({page:pi, rect:rect, colorKey:colorKey(readColorArray(ad.get(PDFName.of('BC')))), contents:'', _used:false});
        pagesNeeded.add(pi);
      }
    }catch(e){}}
  }
  if(!squares.length)return[];

  /* Text layer for Square text (Column A) */
  status.textContent+="Extracting text layer...\n";
  var ptd = await loadTextLayers(pdfData, pagesNeeded);

  /* Use pdf.js getAnnotations() for FreeText contents (Column C) ‚Äî reliable high-level API */
  status.textContent+="Reading FreeText contents via pdf.js...\n";
  var pdfJs = await pdfjsLib.getDocument({data:pdfData}).promise;
  for(var pi of pagesNeeded){
    var pg = await pdfJs.getPage(pi+1);
    var annots = await pg.getAnnotations();
    for(var a=0; a<annots.length; a++){
      var ann = annots[a];
      if(ann.subtype !== 'FreeText') continue;
      var annRect = ann.rect;
      /* Match this pdf.js annotation to our pdf-lib FreeText by rect overlap */
      for(var f=0; f<freeTexts.length; f++){
        var ft = freeTexts[f];
        if(ft.page !== pi || ft.contents) continue;
        /* Check if rects match (within 1pt tolerance) */
        var rMatch = Math.abs(ft.rect[0]-annRect[0])<2 && Math.abs(ft.rect[1]-annRect[1])<2 &&
                     Math.abs(ft.rect[2]-annRect[2])<2 && Math.abs(ft.rect[3]-annRect[3])<2;
        if(rMatch){
          /* Get text from pdf.js annotation ‚Äî try multiple fields */
          var txt = '';
          if(ann.contentsObj && ann.contentsObj.str) txt = ann.contentsObj.str;
          else if(ann.contents) txt = ann.contents;
          ft.contents = txt;
          break;
        }
      }
    }
  }

  status.textContent+="Matching boxes to comments...\n";
  var results=[];
  for(var s=0; s<squares.length; s++){
    var sq=squares[s];
    var items=ptd[sq.page]||[];
    var txt = extractTextFromRect(items, sq.rect);
    if(!txt)continue;

    var mc='', mi=-1;
    if(sq.colorKey){
      var bd=1e9;
      for(var f=0;f<freeTexts.length;f++){
        var ft=freeTexts[f];
        if(ft._used||ft.page!==sq.page||ft.colorKey!==sq.colorKey)continue;
        var d=Math.hypot((ft.rect[0]+ft.rect[2])/2-(sq.rect[0]+sq.rect[2])/2,(ft.rect[1]+ft.rect[3])/2-(sq.rect[1]+sq.rect[3])/2);
        if(d<bd){bd=d; mc=ft.contents; mi=f;}
      }
    }
    if(mi<0){
      var bd=1e9;
      for(var f=0;f<freeTexts.length;f++){
        var ft=freeTexts[f];
        if(ft._used||ft.page!==sq.page)continue;
        var d=Math.hypot((ft.rect[0]+ft.rect[2])/2-(sq.rect[0]+sq.rect[2])/2,(ft.rect[1]+ft.rect[3])/2-(sq.rect[1]+sq.rect[3])/2);
        if(d<bd){bd=d; mc=ft.contents; mi=f;}
      }
    }
    if(mi>=0)freeTexts[mi]._used=true;
    results.push({page:sq.page+1, text:txt, comment:mc});
  }
  return results;
}

function buildSpreadsheet(results){
  var wb=XLSX.utils.book_new(), wsData=[["Text from PDF","","Annotation Comment"]];
  for(var i=0;i<results.length;i++) wsData.push([results[i].text, "", results[i].comment]);
  var ws=XLSX.utils.aoa_to_sheet(wsData);
  ws["!cols"]=[{wch:60},{wch:5},{wch:60}];
  XLSX.utils.book_append_sheet(wb, ws, "Extracted Annotations");
  return new Blob([XLSX.write(wb,{bookType:"xlsx",type:"array"})],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
}

/* ===== COLORIZE ===== */
document.getElementById("colorizeBtn").onclick=async function(){
  var file=pdfInput.files[0]; if(!file)return;
  this.disabled=true; this.textContent="Colorizing...";
  status.style.display="block"; status.textContent="Loading PDF for colorization...\n";
  document.getElementById("colorizeDownloadSection").style.display="none";
  document.getElementById("previewSection").style.display="none";
  try{
    previewPdfData=new Uint8Array(await file.arrayBuffer());
    await new Promise(function(r){setTimeout(r,50);});
    colorizedAnnots=await colorizeAnnotations(previewPdfData);
    updateFdfDownload();
    var pj=await pdfjsLib.getDocument({data:previewPdfData}).promise;
    previewNumPages=pj.numPages; previewPageIdx=0; selectedAnnots=[];
    await renderPreviewPage();
    status.textContent+="Done! Click annotations to select. Ctrl+click to multi-select.\nSelect a FreeText + others, then press Space to match colors.";
  }catch(err){status.textContent+="\nError: "+err.message;console.error(err);}
  this.disabled=false; this.textContent="Colorize";
};

function updateFdfDownload(){
  var fdf=generateColorizedFDF(colorizedAnnots);
  var blob=new Blob([fdf],{type:'application/vnd.fdf'}), url=URL.createObjectURL(blob);
  var nm=(pdfInput.files[0]?pdfInput.files[0].name:"file").replace(/\.pdf$/i,"");
  var dl=document.getElementById("colorizeDownloadLink");
  dl.href=url; dl.setAttribute("download",nm+" colorized.fdf");
  document.getElementById("colorizeDownloadSection").style.display="block";
}

async function colorizeAnnotations(pdfData){
  ensurePdfLib();
  status.textContent+="Reading annotations...\n";
  var lib=await PDFDocument.load(pdfData,{ignoreEncryption:true}), pgs=lib.getPages(), pa={};
  var pagesNeeded=new Set();

  for(var pi=0;pi<pgs.length;pi++){
    var ar=pgs[pi].node.get(PDFName.of('Annots')); if(!ar)continue;
    var ans=pgs[pi].node.lookup(PDFName.of('Annots')); if(!ans||!(ans instanceof PDFArray))continue;
    pa[pi]={squares:[],freeTexts:[],lines:[],all:[]};
    pagesNeeded.add(pi);
    for(var j=0;j<ans.size();j++){try{
      var ad=lib.context.lookup(ans.get(j)); if(!(ad instanceof PDFDict))continue;
      var st=ad.get(PDFName.of('Subtype')); if(!st)continue;
      var sn=st.asString().replace('/','');
      var rect=readRectArray(ad.get(PDFName.of('Rect'))); if(!rect)continue;
      var e={subtype:sn, rect:rect, dict:ad, page:pi, contents:'', rawContents:''};
      if(sn==='Line'){
        var ll=ad.get(PDFName.of('L'));
        if(ll&&ll instanceof PDFArray){e.endpoints=[];for(var i=0;i<ll.size();i++){var v=ll.get(i);e.endpoints.push(typeof v.asNumber==='function'?v.asNumber():parseFloat(v.toString()));}}
      }
      if(sn==='FreeText'){
        /* Raw: PDF-escaped string for FDF passthrough (no decoding, no re-encoding) */
        var cObj=ad.get(PDFName.of('Contents'));
        if(cObj){
          var raw=cObj.toString(); /* returns (escaped content) or <hex> */
          /* Strip outer parens or angle brackets for FDF embedding */
          if(raw.charAt(0)==='(' && raw.charAt(raw.length-1)===')')
            e.rawContents=raw.substring(1,raw.length-1);
          else if(raw.charAt(0)==='<' && raw.charAt(raw.length-1)==='>')
            e.rawContents=raw.substring(1,raw.length-1);
          else
            e.rawContents=raw;
          /* Decoded: for preview display only */
          e.contents=readPdfString(cObj);
        }
      }
      pa[pi].all.push(e);
      if(sn==='Square')pa[pi].squares.push(e);
      else if(sn==='FreeText')pa[pi].freeTexts.push(e);
      else if(sn==='Line')pa[pi].lines.push(e);
    }catch(ex){}}
  }

  var out=[];
  for(var pi in pa){
    var pg=pa[pi];
    if(!pg.squares.length){for(var i=0;i<pg.all.length;i++)out.push(buildAnnotOutput(pg.all[i],null));continue;}
    status.textContent+="  Page "+(+pi+1)+": "+pg.squares.length+" box, "+pg.freeTexts.length+" text, "+pg.lines.length+" line\n";
    var uFT=new Set(),uLN=new Set();
    for(var si=0;si<pg.squares.length;si++){
      var sq=pg.squares[si], color=PP[si%PP.length];
      var sL=Math.min(sq.rect[0],sq.rect[2]),sR=Math.max(sq.rect[0],sq.rect[2]),sB=Math.min(sq.rect[1],sq.rect[3]),sT=Math.max(sq.rect[1],sq.rect[3]),sCX=(sL+sR)/2,sCY=(sB+sT)/2;
      var mLn=null,mLi=-1,bLD=1e9;
      for(var li=0;li<pg.lines.length;li++){if(uLN.has(li))continue;var ln=pg.lines[li];if(!ln.endpoints||ln.endpoints.length<4)continue;var ep=ln.endpoints;var e1=pnr(ep[0],ep[1],sL,sB,sR,sT,15),e2=pnr(ep[2],ep[3],sL,sB,sR,sT,15);if(e1||e2){var d=e1?Math.hypot(ep[0]-sCX,ep[1]-sCY):Math.hypot(ep[2]-sCX,ep[3]-sCY);if(d<bLD){bLD=d;mLn=ln;mLi=li;}}}
      var mFT=null,mFI=-1;
      if(mLn&&mLn.endpoints){var ep=mLn.endpoints;var e1=pnr(ep[0],ep[1],sL,sB,sR,sT,15);var fX=e1?ep[2]:ep[0],fY=e1?ep[3]:ep[1];var bD=1e9;for(var fi=0;fi<pg.freeTexts.length;fi++){if(uFT.has(fi))continue;var ft=pg.freeTexts[fi];var fL=Math.min(ft.rect[0],ft.rect[2]),fR=Math.max(ft.rect[0],ft.rect[2]),fB=Math.min(ft.rect[1],ft.rect[3]),fT=Math.max(ft.rect[1],ft.rect[3]);if(pnr(fX,fY,fL,fB,fR,fT,20)){var d=Math.hypot(fX-(fL+fR)/2,fY-(fB+fT)/2);if(d<bD){bD=d;mFT=ft;mFI=fi;}}}}
      if(!mFT){var bD=1e9;for(var fi=0;fi<pg.freeTexts.length;fi++){if(uFT.has(fi))continue;var ft=pg.freeTexts[fi];var fL=Math.min(ft.rect[0],ft.rect[2]),fR=Math.max(ft.rect[0],ft.rect[2]),fB=Math.min(ft.rect[1],ft.rect[3]),fT=Math.max(ft.rect[1],ft.rect[3]);var yO=!(fT<sB-30||fB>sT+30);var d=Math.hypot((fL+fR)/2-sCX,(fB+fT)/2-sCY);var eff=yO?d:d*2;if(eff<bD){bD=eff;mFT=ft;mFI=fi;}}}
      if(mFI>=0)uFT.add(mFI);if(mLi>=0)uLN.add(mLi);
      out.push(buildAnnotOutput(sq,color));
      if(mFT)out.push(buildAnnotOutput(mFT,color));
      if(mLn)out.push(buildAnnotOutput(mLn,color));
    }
    for(var fi=0;fi<pg.freeTexts.length;fi++)if(!uFT.has(fi))out.push(buildAnnotOutput(pg.freeTexts[fi],null));
    for(var li=0;li<pg.lines.length;li++)if(!uLN.has(li))out.push(buildAnnotOutput(pg.lines[li],null));
    for(var i=0;i<pg.all.length;i++){var a=pg.all[i];if(a.subtype!=='Square'&&a.subtype!=='FreeText'&&a.subtype!=='Line')out.push(buildAnnotOutput(a,null));}
  }
  status.textContent+="Colorized "+out.length+" annotation(s).\n";
  return out;
}

/* ===== PREVIEW ===== */
async function renderPreviewPage(){
  document.getElementById('previewSection').style.display='block';
  document.getElementById('pageLabel').textContent="(Page "+(previewPageIdx+1)+" of "+previewNumPages+")";
  var pj=await pdfjsLib.getDocument({data:previewPdfData}).promise;
  var pg=await pj.getPage(previewPageIdx+1), vp=pg.getViewport({scale:previewScale});
  var c=document.getElementById('previewCanvas'), ctx=c.getContext('2d');
  c.width=vp.width; c.height=vp.height;
  var o=document.getElementById('overlayCanvas'); o.width=vp.width; o.height=vp.height;
  await pg.render({canvasContext:ctx, viewport:vp, annotationMode:0}).promise;
  drawOverlays();
}

function drawOverlays(){
  var o=document.getElementById('overlayCanvas'), ctx=o.getContext('2d');
  ctx.clearRect(0,0,o.width,o.height);
  var S=previewScale, pH=document.getElementById('previewCanvas').height/S;
  for(var ai=0;ai<colorizedAnnots.length;ai++){
    var a=colorizedAnnots[ai]; if(a.page!==previewPageIdx)continue;
    var r=a.rect, rL=Math.min(r[0],r[2]),rR=Math.max(r[0],r[2]),rB=Math.min(r[1],r[3]),rT=Math.max(r[1],r[3]);
    var cx=rL*S, cy=(pH-rT)*S, cw=(rR-rL)*S, ch=(rT-rB)*S;
    var col=a.subtype==='FreeText'?(a.colorBC||a.colorC):a.colorC;
    var hex=col?rgbToHex(col):'#cc0000';
    var cname=getColorName(col);
    var sel=selectedAnnots.includes(ai);
    if(a.subtype==='Line'&&a.endpoints&&a.endpoints.length>=4){
      var ep=a.endpoints;
      ctx.strokeStyle=hex; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(ep[0]*S,(pH-ep[1])*S); ctx.lineTo(ep[2]*S,(pH-ep[3])*S); ctx.stroke();
      if(sel){ctx.strokeStyle='#fff';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(ep[0]*S,(pH-ep[1])*S);ctx.lineTo(ep[2]*S,(pH-ep[3])*S);ctx.stroke();ctx.setLineDash([]);}
    }else if(a.subtype==='Square'){
      ctx.strokeStyle=hex; ctx.lineWidth=2; ctx.strokeRect(cx,cy,cw,ch);
      ctx.fillStyle=hex+'15'; ctx.fillRect(cx,cy,cw,ch);
      if(cname){ctx.font='9px sans-serif';ctx.fillStyle=hex;var tw=ctx.measureText(cname).width;ctx.fillText(cname,cx+cw-tw-3,cy+ch-4);}
      if(sel){ctx.strokeStyle='#fff';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.strokeRect(cx,cy,cw,ch);ctx.setLineDash([]);}
    }else if(a.subtype==='FreeText'){
      ctx.fillStyle='#ffffffd0'; ctx.fillRect(cx,cy,cw,ch);
      ctx.strokeStyle=hex; ctx.lineWidth=2; ctx.strokeRect(cx,cy,cw,ch);
      ctx.fillStyle=hex; ctx.font='10px sans-serif';
      var txt=a.contents||'';
      ctx.fillText(txt.substring(0,50), cx+3, cy+13);
      if(txt.length>50) ctx.fillText(txt.substring(50,100), cx+3, cy+25);
      if(cname){ctx.font='9px sans-serif';ctx.fillStyle=hex;var tw=ctx.measureText(cname).width;ctx.fillText(cname,cx+cw-tw-3,cy+ch-4);}
      if(sel){ctx.strokeStyle='#fff';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.strokeRect(cx,cy,cw,ch);ctx.setLineDash([]);}
    }
  }
}

/* ===== CLICK SELECTION ===== */
document.getElementById('previewWrap').addEventListener('click',function(e){
  if(!colorizedAnnots.length)return;
  var c=document.getElementById('previewCanvas'),br=c.getBoundingClientRect(),S=previewScale,pH=c.height/S;
  var pX=(e.clientX-br.left)/S, pY=pH-(e.clientY-br.top)/S;
  var bi=-1,ba=1e9;
  for(var ai=0;ai<colorizedAnnots.length;ai++){
    var a=colorizedAnnots[ai]; if(a.page!==previewPageIdx)continue;
    if(a.subtype==='Line'&&a.endpoints&&a.endpoints.length>=4){if(dts(pX,pY,a.endpoints[0],a.endpoints[1],a.endpoints[2],a.endpoints[3])<8&&50<ba){ba=50;bi=ai;}}
    else{var r=a.rect,P=3,rL=Math.min(r[0],r[2]),rR=Math.max(r[0],r[2]),rB=Math.min(r[1],r[3]),rT=Math.max(r[1],r[3]);if(pX>=rL-P&&pX<=rR+P&&pY>=rB-P&&pY<=rT+P){var ar=(rR-rL)*(rT-rB);if(ar<ba){ba=ar;bi=ai;}}}
  }
  if(bi>=0){if(e.ctrlKey||e.metaKey){var ei=selectedAnnots.indexOf(bi);if(ei>=0)selectedAnnots.splice(ei,1);else selectedAnnots.push(bi);}else selectedAnnots=[bi];}
  else selectedAnnots=[];
  drawOverlays();updateSelInfo();
});

function dts(px,py,x1,y1,x2,y2){var dx=x2-x1,dy=y2-y1,l2=dx*dx+dy*dy;if(!l2)return Math.hypot(px-x1,py-y1);var t=((px-x1)*dx+(py-y1)*dy)/l2;t=Math.max(0,Math.min(1,t));return Math.hypot(px-(x1+t*dx),py-(y1+t*dy));}

function updateSelInfo(){
  var info=document.getElementById('selectionInfo');
  if(!selectedAnnots.length){info.style.display='none';return;}
  info.style.display='block';
  var html='<b>Selected:</b> ';
  var ftIdx;
  for(var i=0;i<selectedAnnots.length;i++){if(colorizedAnnots[selectedAnnots[i]].subtype==='FreeText'){ftIdx=selectedAnnots[i];break;}}
  for(var i=0;i<selectedAnnots.length;i++){var ai=selectedAnnots[i];var a=colorizedAnnots[ai];var col=a.subtype==='FreeText'?(a.colorBC||a.colorC):a.colorC;html+='<span class="sel-swatch" style="background:'+(col?rgbToHex(col):'#ccc')+'"></span>'+a.subtype+' ';}
  if(ftIdx!==undefined&&selectedAnnots.length>1)html+='<button style="background:#e65100;font-size:14px;padding:8px 16px;margin-left:10px;color:#fff;border:none;border-radius:6px;cursor:pointer;" onclick="matchToFT('+ftIdx+')">Match colors to FreeText (Space)</button>';
  else if(ftIdx!==undefined)html+='<span style="color:#888;margin-left:10px;">Ctrl+click more annotations to match</span>';
  else html+='<span style="color:#888;margin-left:10px;">Include a FreeText in selection to match colors</span>';
  info.innerHTML=html;
}

/* ===== MATCH COLORS ===== */
function matchToFT(ftIdx){
  var tc=colorizedAnnots[ftIdx].colorBC||colorizedAnnots[ftIdx].colorC; if(!tc)return;
  for(var i=0;i<selectedAnnots.length;i++){var ai=selectedAnnots[i];if(ai===ftIdx)continue;applyColor(colorizedAnnots[ai],tc);}
  drawOverlays();updateSelInfo();updateFdfDownload();
}
function applyColor(a,color){
  var rs=color.map(function(v){return Math.round(v*1e6)/1e6;}).join(' '), hex=rgbToHex(color);
  if(a.subtype==='Square')a.colorC=color;
  else if(a.subtype==='FreeText'){
    a.colorBC=color;
    if(a.da)a.da=a.da.replace(/[\d.]+ [\d.]+ [\d.]+ rg/,rs+' rg');else a.da=rs+' rg /Arial 10 Tf';
    if(a.ds)a.ds=a.ds.replace(/color:\s*#[0-9a-fA-F]{6}/,'color:'+hex);else a.ds='font: Arial,sans-serif 10.0pt; text-align:left; color:'+hex;
  }else if(a.subtype==='Line')a.colorC=color;
}
document.addEventListener('keydown',function(e){
  if(e.code==='Space'&&selectedAnnots.length>0&&document.getElementById('previewSection').style.display!=='none'){
    e.preventDefault();var fi;for(var i=0;i<selectedAnnots.length;i++){if(colorizedAnnots[selectedAnnots[i]].subtype==='FreeText'){fi=selectedAnnots[i];break;}}if(fi!==undefined)matchToFT(fi);}
});

/* ===== PAGE NAV ===== */
document.getElementById('prevPageBtn').onclick=async function(){if(previewPageIdx>0){previewPageIdx--;selectedAnnots=[];await renderPreviewPage();updateSelInfo();}};
document.getElementById('nextPageBtn').onclick=async function(){if(previewPageIdx<previewNumPages-1){previewPageIdx++;selectedAnnots=[];await renderPreviewPage();updateSelInfo();}};

/* ===== HELPERS ===== */
function readRectArray(o){if(!o||!(o instanceof PDFArray))return null;var a=[];for(var i=0;i<o.size();i++){var v=o.get(i);a.push(typeof v.asNumber==='function'?v.asNumber():parseFloat(v.toString()));}return a.length>=4?a:null;}
function readColorArray(o){if(!o||!(o instanceof PDFArray))return null;var a=[];for(var i=0;i<o.size();i++){var v=o.get(i);a.push(typeof v.asNumber==='function'?v.asNumber():parseFloat(v.toString()));}return a.length>=3?a:null;}

/* readPdfString: ONLY used for metadata fields (DA, DS, T, Subj) ‚Äî NOT for /Contents.
   Contents are extracted from pdf.js text layer instead. */
function readPdfString(o){
  if(!o)return'';
  if(typeof o.asString==='function')return o.asString();
  if(o instanceof PDFHexString)return o.decodeText();
  if(o instanceof PDFString)return o.asString();
  return o.toString();
}

function colorKey(c){if(!c||c.length<3)return'';return c.map(function(v){return Math.round(v*10000)/10000;}).join(',');}
function rgbToHex(c){if(!c||c.length<3)return'#cccccc';return'#'+c.map(function(v){return Math.round(v*255).toString(16).padStart(2,'0');}).join('');}
function pnr(px,py,l,b,r,t,tol){if(px<l-tol||px>r+tol||py<b-tol||py>t+tol)return false;var iY=py>=b-tol&&py<=t+tol,iX=px>=l-tol&&px<=r+tol;return(Math.abs(px-l)<=tol&&iY)||(Math.abs(px-r)<=tol&&iY)||(Math.abs(py-b)<=tol&&iX)||(Math.abs(py-t)<=tol&&iX);}

function buildAnnotOutput(entry,color){
  var o={subtype:entry.subtype, rect:entry.rect, page:entry.page};

  /* rawContents: already PDF-escaped, for FDF passthrough (FreeText only) */
  if(entry.rawContents) o.rawContents=entry.rawContents;
  /* contents: decoded text for preview display */
  if(entry.contents) o.contents=entry.contents;

  /* Metadata fields read from pdf-lib (simple ASCII, safe) */
  var t=entry.dict.get(PDFName.of('T')); if(t)o.title=readPdfString(t);
  var subj=entry.dict.get(PDFName.of('Subj')); if(subj)o.subject=readPdfString(subj);
  var da=entry.dict.get(PDFName.of('DA')); if(da)o.da=readPdfString(da);
  var ds=entry.dict.get(PDFName.of('DS')); if(ds)o.ds=readPdfString(ds);
  var bs=entry.dict.get(PDFName.of('BS'));
  if(bs&&bs instanceof PDFDict){var w=bs.get(PDFName.of('W'));if(w)o.borderWidth=typeof w.asNumber==='function'?w.asNumber():parseFloat(w.toString());}
  if(entry.endpoints)o.endpoints=entry.endpoints;
  o.colorC=readColorArray(entry.dict.get(PDFName.of('C')));
  o.colorBC=readColorArray(entry.dict.get(PDFName.of('BC')));
  if(color){
    var rs=color.map(function(v){return Math.round(v*1e6)/1e6;}).join(' '), hex=rgbToHex(color);
    if(entry.subtype==='Square')o.colorC=color;
    else if(entry.subtype==='FreeText'){
      o.colorBC=color;
      if(!o.colorC||(o.colorC[0]>0.9&&o.colorC[1]>0.9&&o.colorC[2]>0.9))o.colorC=[1,1,0.988235];
      if(o.da)o.da=o.da.replace(/[\d.]+ [\d.]+ [\d.]+ rg/,rs+' rg');else o.da=rs+' rg /Arial 10 Tf';
      if(o.ds)o.ds=o.ds.replace(/color:\s*#[0-9a-fA-F]{6}/,'color:'+hex);else o.ds='font: Arial,sans-serif 10.0pt; text-align:left; color:'+hex;
    }else if(entry.subtype==='Line')o.colorC=color;
  }
  return o;
}

/* ===== FDF GENERATION =====
   Simple and clean. Contents come from pdf.js text layer = plain text.
   Only escape ( ) and \ for FDF parenthesized strings. */
function escFDF(s){
  if(!s)return'';
  return s.replace(/\\/g,'\\\\').replace(/\(/g,'\\(').replace(/\)/g,'\\)');
}
function colorStr(c){if(!c||c.length<3)return'';return c.map(function(v){return Math.round(v*1e6)/1e6;}).join(' ');}

function generateColorizedFDF(annotations){
  var blocks=[];
  for(var i=0;i<annotations.length;i++){
    var a=annotations[i];
    var b='<<\n/Type /Annot\n/Subtype /'+a.subtype+'\n/Rect ['+a.rect.join(' ')+']\n/Page '+a.page;
    /* Use rawContents (already PDF-escaped) if available, otherwise fall back to escFDF */
    if(a.rawContents) b+='\n/Contents ('+a.rawContents+')';
    else if(a.contents) b+='\n/Contents ('+escFDF(a.contents)+')';
    if(a.title)b+='\n/T ('+escFDF(a.title)+')';
    if(a.colorC&&a.colorC.length>=3)b+='\n/C ['+colorStr(a.colorC)+']';
    if(a.colorBC&&a.colorBC.length>=3)b+='\n/BC ['+colorStr(a.colorBC)+']';
    if(a.borderWidth!==undefined)b+='\n/BS << /W '+a.borderWidth+' >>';
    if(a.da)b+='\n/DA ('+escFDF(a.da)+')';
    if(a.ds)b+='\n/DS ('+escFDF(a.ds)+')';
    if(a.subject)b+='\n/Subj ('+escFDF(a.subject)+')';
    if(a.endpoints&&a.endpoints.length>=4)b+='\n/L ['+a.endpoints.join(' ')+']';
    b+='\n>>'; blocks.push(b);
  }
  return '%FDF-1.2\n1 0 obj\n<< /FDF << /Annots [\n'+blocks.join('\n')+'\n] >> >>\nendobj\ntrailer\n<< /Root 1 0 R >>\n%%EOF';
}
</script>
</body>
</html>
